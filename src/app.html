<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <script src="fancy-settings/source/lib/store.js"></script>
  </head>

  <body>
    <script>
      var GitHubNotifications = (function(){

        var settings = new Store("settings", {
          "show-badge-even-with-zero-messages": true,
          "interval": 90000
        });

        function extractUnreadNotifications(response) {
          var matches = response.match(/<span class="unread_count">([^<]+)<\/span>/);

          if ((matches != null) && (matches.length == 2)) {
            var unreadNotifications = parseInt(matches[1]);
            return unreadNotifications;
          }

          return 0;
        }

        return {
          YELLOW: [255, 223, 1, 255],
          BLUE: [0, 128, 255, 255],
          NOTIFICATION_URL: 'https://github.com/inbox/notifications',

          unreadNotifications: 0,

          init: function(){
            GitHubNotifications.checkNotifications();
            GitHubNotifications.checkNotificationsAfterTimeout();

            chrome.browserAction.onClicked.addListener(function() {
              window.open(GitHubNotifications.NOTIFICATION_URL);
            });
          },

          checkNotificationsAfterTimeout: function(){
            GitHubNotifications.INTERVAL_BETWEEN_CHECK_NOTIFICATIONS = settings.get("interval");

            window.setTimeout(
              function(){
                GitHubNotifications.checkNotifications();
                GitHubNotifications.checkNotificationsAfterTimeout();
              },
              GitHubNotifications.INTERVAL_BETWEEN_CHECK_NOTIFICATIONS
            );
          },

          checkNotifications: function() {
            var xhr = new XMLHttpRequest();
            xhr.open("GET", GitHubNotifications.NOTIFICATION_URL, true);

            xhr.onreadystatechange = function() {
              if (xhr.readyState == 4) {
                var response = xhr.response;

                // not logged in
                if (response.match(/<body class="logged_out/)) {
                  chrome.browserAction.setBadgeBackgroundColor({color: GitHubNotifications.YELLOW});
                  chrome.browserAction.setBadgeText({text: '!'});
                  chrome.browserAction.setTitle({title: "You should login on GitHub :)"});
                  return;
                }

                // logged in
                GitHubNotifications.unreadNotifications = extractUnreadNotifications(response) + "";

                chrome.browserAction.setBadgeBackgroundColor({color: GitHubNotifications.BLUE});

                if (settings.get("show-badge-even-with-zero-messages") == true) {
                  chrome.browserAction.setBadgeText({text: GitHubNotifications.unreadNotifications});
                } else {
                  if (parseInt(GitHubNotifications.unreadNotifications)) {
                    chrome.browserAction.setBadgeText({text: GitHubNotifications.unreadNotifications});
                  } else {
                    chrome.browserAction.setBadgeText({text: ''});
                  }
                }

                // TODO: int?
                var notificationsInflection = (GitHubNotifications.unreadNotifications == 1 ? 'notification' : 'notifications');

                var title = GitHubNotifications.unreadNotifications + " unread " + notificationsInflection;
                chrome.browserAction.setTitle({title: title});
              }
            }
            xhr.send(null);
          }
        };

      })();

      GitHubNotifications.init();
    </script>
  </body>
</html>